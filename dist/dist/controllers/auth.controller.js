"use strict";var _jsonwebtoken=require("jsonwebtoken"),_jsonwebtoken2=_interopRequireDefault(_jsonwebtoken),_user=require("../models/user"),_user2=_interopRequireDefault(_user),_main=require("../config/main"),_main2=_interopRequireDefault(_main),_util=require("../services/util.service"),_lodash=require("lodash");function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}function generateToken(e){return _jsonwebtoken2.default.sign(e,_main2.default.SECRET,{expiresIn:3600})}require("crypto");var populateRoleAndPermissions={path:"role",populate:{path:"permissions"}},authController=function(){return{login:function(e,r,t){e.user.populate({path:"role",populate:{path:"permissions"}},function(n){if(n)return t(n);var o=(0,_util.setUserInfo)(e.user);r.status(200).json({token:"JWT  "+generateToken(o),user:o}),t()})},hasAuthorization:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:[],r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:[];return e=[].concat([],e),r=[].concat([],r),function(t,n,o){var s=t.user;_user2.default.findById(s._id).populate("role").exec(function(t,s){if(t)return n.status(422).json({error:"No user found."}),o(t);var u=s.role.permissions.map(function(e){return e.label});return e.indexOf(s.role.label)>-1||(0,_lodash.intersection)(r,u).length>0?o():(n.status(401).json({error:"You are not authorized to view this content"}),o("Unauthorized"))})}},register:function(e,r,t){var n=e.body.email,o=e.body.firstName,s=e.body.lastName,u=e.body.password,a=e.body.role;return n?o&&s?u?void _user2.default.findOne({email:n},function(e,i){return e?t(e):i?r.status(422).send({error:"That email address is already in use."}):void new _user2.default({email:n,password:u,firstName:o,lastName:s,role:a}).save(function(e,n){if(e)return t(e);n.populate(populateRoleAndPermissions,function(e){if(e)return t(e);var o=(0,_util.setUserInfo)(n);r.status(201).json({token:"JWT  "+generateToken(o),user:o})})})}):r.status(422).send({error:"You must enter a password."}):r.status(422).send({error:"You must enter your full name."}):r.status(422).send({error:"You must enter an email address."})}}};module.exports=authController;